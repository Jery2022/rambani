<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rambani - Chat Privé</title>
    <!-- Inclure Font Awesome pour les icônes (facultatif mais recommandé pour l'esthétique) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/style.min.css" />
  </head>
  <body>
    <div id="main-container">
      <!-- Barre Horizontale Supérieure -->
      <header id="chat-header">
        <div class="header-title">
          <img
            src="images/img_logo_rambani_v0.png"
            alt="Logo Rambani"
            loading="lazy"
          />
          <h1>Chat Privé</h1>
        </div>
        <div class="header-right">
          <button id="quit-button">
            <i class="fa-solid fa-power-off"></i> Quitter
          </button>
          <div class="notification-icon">
            <i class="fa-solid fa-bell"></i>
            <span class="badge" id="unread-messages-badge">0</span>
          </div>
        </div>
      </header>

      <!-- Barre de Navigation Secondaire -->
      <nav id="secondary-nav">
        <button id="sidebar-toggle-button">
          <i class="fa-solid fa-bars"></i>
        </button>
        <!-- Icône pour ouvrir/fermer la sidebar -->
        <button
          id="open-profile-modal-button"
          style="
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            margin-left: 20px;
          "
        >
          <i class="fa-solid fa-user-edit"></i> Mon Profil
        </button>
      </nav>

      <!-- Colonne Latérale (Sidebar) - Liste des Utilisateurs -->
      <aside id="user-sidebar">
        <div id="current-user-profile">
          <!-- L'ID sera injecté ici par JS -->
          <div class="avatar" id="my-avatar"></div>
          <span id="my-user-id">Chargement...</span>
        </div>

        <h3>
          Utilisateurs Connectés (<span id="connected-users-count">0</span>)
        </h3>
        <!-- Conteneur pour la liste des autres utilisateurs -->
        <ul class="user-list" id="users-list">
          <li style="color: #666; font-style: italic">
            Aucun autre utilisateur en ligne.
          </li>
        </ul>
      </aside>

      <!-- Zone Principale du Chat -->
      <main id="chat-area">
        <div id="messages-wrapper">
          <ul id="messages"></ul>
        </div>

        <form id="form" action="">
          <input
            id="input"
            autocomplete="off"
            placeholder="Tapez votre message..."
          /><button><i class="fa-solid fa-paper-plane"></i> Envoyer</button>
        </form>
      </main>
    </div>

    <!-- MODAL DE CONFIRMATION -->
    <div id="confirmation-modal">
      <div>
        <p>Êtes-vous sûr de vouloir quitter le chat ?</p>
        <div
          class="modal-buttons"
          style="display: flex; justify-content: space-around; margin-top: 20px"
        >
          <button id="confirm-quit">Quitter</button>
          <button id="cancel-quit">Annuler</button>
        </div>
      </div>
    </div>
    <!-- FIN MODAL -->

    <!-- Modale de mise à jour du profil -->
    <div id="profile-update-modal-container"></div>
    <!-- FIN Modale de mise à jour du profil -->

    <!-- Modale de succès générique -->
    <div id="success-modal" class="modal" style="display: none">
      <div class="modal-content">
        <p id="success-modal-message"></p>
        <button id="success-modal-ok-button">OK</button>
      </div>
    </div>
    <!-- FIN Modale de succès générique -->

    <script src="/socket.io/socket.io.js"></script>

    <script>
      // Encapsulation du code dans l'événement DOMContentLoaded pour garantir que la librairie Socket.IO est chargée
      document.addEventListener("DOMContentLoaded", () => {
        const socket = io(); // L'appel à io() sécurisé

        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const messages = document.getElementById("messages");
        const usersList = document.getElementById("users-list");
        const quitButton = document.getElementById("quit-button");
        const sidebarToggleButton = document.getElementById(
          "sidebar-toggle-button"
        ); // Nouveau bouton
        const userSidebar = document.getElementById("user-sidebar"); // La sidebar elle-même
        const myUserIdSpan = document.getElementById("my-user-id");
        const myAvatarDiv = document.getElementById("my-avatar");
        const unreadMessagesBadge = document.getElementById(
          "unread-messages-badge"
        );
        const connectedUsersCountSpan = document.getElementById(
          "connected-users-count"
        ); // Nouvel élément pour le compteur

        // Récupération des éléments du modal
        const confirmationModal = document.getElementById("confirmation-modal");
        const confirmQuitButton = document.getElementById("confirm-quit");
        const cancelQuitButton = document.getElementById("cancel-quit");

        // Récupération des éléments de la modale de profil
        const profileUpdateModalContainer = document.getElementById(
          "profile-update-modal-container"
        );
        const openProfileModalButton = document.getElementById(
          "open-profile-modal-button"
        );
        let profileUpdateModal; // Sera défini après le chargement du contenu
        let closeProfileModalButton;
        let profileUpdateForm;
        let firstNameInput,
          lastNameInput,
          usernameInput,
          emailInput,
          profilePictureInput,
          currentProfilePictureImg,
          csrfTokenInput,
          profileErrorMessage,
          cancelProfileUpdateButton;

        let currentUserId = null; // Variable pour stocker l'ID local
        let unreadMessagesCount = 0; // Compteur de messages non lus

        // Récupération des éléments de la modale de succès
        const successModal = document.getElementById("success-modal");
        const successModalMessage = document.getElementById(
          "success-modal-message"
        );
        const successModalOkButton = document.getElementById(
          "success-modal-ok-button"
        );

        // Fonction pour afficher le modal (pour les alertes simples ou succès)
        function showAlertModal(message, onOk = null, isError = false) {
          if (isError) {
            // Utilise la modale de confirmation pour les erreurs
            confirmationModal.querySelector("p").textContent = message;
            confirmationModal.querySelector("#confirm-quit").textContent = "OK";
            confirmationModal.querySelector("#cancel-quit").style.display =
              "none"; // Cache le bouton Annuler
            confirmationModal.style.display = "flex";
            confirmationModal.querySelector("#confirm-quit").onclick = () => {
              confirmationModal.style.display = "none";
              if (onOk) onOk();
            };
          } else {
            // Utilise la modale de succès pour les succès
            successModalMessage.textContent = message;
            successModal.style.display = "flex";
            successModalOkButton.onclick = () => {
              successModal.style.display = "none";
              if (onOk) onOk();
            };
          }
        }

        // Gérer la réception de l'ID utilisateur actuel du serveur et des informations de profil
        socket.on("current user", function (userProfile) {
          currentUserId = userProfile.username;
          myUserIdSpan.textContent = " - " + currentUserId + " (Moi)";
          if (userProfile.profilePicture) {
            myAvatarDiv.style.backgroundImage = `url('${userProfile.profilePicture}')`;
          } else {
            myAvatarDiv.style.backgroundImage = `url('images/default_avatar_v1.png')`; // Fallback
          }
        });

        // Fonction utilitaire pour mettre à jour le badge de messages non lus
        function updateUnreadMessagesBadge() {
          if (unreadMessagesCount > 0) {
            unreadMessagesBadge.textContent = unreadMessagesCount;
            unreadMessagesBadge.style.display = "block"; // Afficher le badge
          } else {
            unreadMessagesBadge.style.display = "none"; // Cacher le badge
          }
        }

        // Fonction utilitaire pour ajouter un message
        function displayMessage(msg) {
          const item = document.createElement("li");

          if (msg.user === "Système" || msg.type === "system") {
            item.textContent = msg.text;
            item.className = "system-message";
          } else {
            item.innerHTML = `<span class="username">${msg.user}</span>: ${msg.text}`;
            // Appliquer la classe appropriée en fonction de l'émetteur
            if (msg.user === currentUserId) {
              // Si le message vient de l'utilisateur actuel
              item.classList.add("my-message");
            } else {
              // Si le message vient d'un autre utilisateur
              item.classList.add("received-message");
            }
          }
          messages.appendChild(item);
          // Faire défiler vers le bas
          const wrapper = document.getElementById("messages-wrapper");
          wrapper.scrollTop = wrapper.scrollHeight;
        }

        // Fonction utilitaire pour mettre à jour la liste des utilisateurs
        function updateUsersList(userProfiles) {
          usersList.innerHTML = ""; // Vide la liste

          // Filtre l'utilisateur actuel et n'affiche que les autres
          const otherUsers = userProfiles.filter(
            (user) => user.username !== currentUserId
          );

          // Mettre à jour le compteur d'utilisateurs connectés
          connectedUsersCountSpan.textContent = userProfiles.length;

          if (otherUsers.length === 0) {
            const item = document.createElement("li");
            item.style.color = "#666";
            item.style.fontStyle = "italic";
            item.textContent = "Aucun autre utilisateur en ligne.";
            usersList.appendChild(item);
            return;
          }

          otherUsers.forEach((user) => {
            const item = document.createElement("li");
            item.className = "user-item";
            item.innerHTML = `
                        <div class="avatar" style="background-image: url('${
                          user.profilePicture || "images/default_avatar.png"
                        }');"></div>
                        <span>${user.username}</span>
                    `;
            usersList.appendChild(item);
          });
        }

        // ----------------------------------------------------
        // LOGIQUE DE LA MODALE DE PROFIL
        // ----------------------------------------------------

        // Charger le contenu de la modale de profil
        fetch("/profile-modal.html")
          .then((response) => response.text())
          .then((html) => {
            profileUpdateModalContainer.innerHTML = html;
            profileUpdateModal = document.getElementById(
              "profile-update-modal"
            );
            closeProfileModalButton =
              profileUpdateModal.querySelector(".close-button");
            profileUpdateForm = document.getElementById("profile-update-form");
            firstNameInput = document.getElementById("first-name");
            lastNameInput = document.getElementById("last-name");
            usernameInput = document.getElementById("username");
            emailInput = document.getElementById("email");
            profilePictureInput = document.getElementById("profile-picture");
            currentProfilePictureImg = document.getElementById(
              "current-profile-picture"
            );
            csrfTokenInput = document.getElementById("csrf-token"); // Récupérer le champ CSRF
            profileErrorMessage = document.getElementById(
              "profile-error-message"
            ); // Récupérer l'élément d'erreur
            cancelProfileUpdateButton = document.getElementById(
              "cancel-profile-update"
            ); // Récupérer le bouton Annuler

            // Fonction pour charger le jeton CSRF et les données du profil
            const loadProfileDataAndCsrf = async () => {
              try {
                // Récupérer le jeton CSRF
                const csrfRes = await fetch("/api/csrf-token");
                const csrfData = await csrfRes.json();
                if (csrfData.csrfToken) {
                  csrfTokenInput.value = csrfData.csrfToken;
                } else {
                  showAlertModal("Erreur: Jeton CSRF non reçu.");
                  return;
                }

                // Charger les données du profil existant
                const profileRes = await fetch("/api/profile");
                const profileData = await profileRes.json();

                if (profileData.success) {
                  firstNameInput.value = profileData.profile.firstName || "";
                  lastNameInput.value = profileData.profile.lastName || "";
                  usernameInput.value = profileData.profile.username || "";
                  emailInput.value = profileData.profile.email || "";
                  if (profileData.profile.profilePicture) {
                    currentProfilePictureImg.src =
                      profileData.profile.profilePicture;
                    currentProfilePictureImg.style.display = "block";
                  } else {
                    currentProfilePictureImg.style.display = "none";
                  }
                } else {
                  showAlertModal(
                    "Erreur lors du chargement du profil: " +
                      profileData.message
                  );
                }
              } catch (error) {
                console.error("Erreur:", error);
                profileErrorMessage.textContent =
                  "Erreur réseau lors du chargement du profil ou du jeton CSRF.";
                profileErrorMessage.style.display = "block";
              }
            };

            // Ouvrir la modale
            openProfileModalButton.addEventListener("click", () => {
              profileUpdateModal.style.display = "flex";
              profileErrorMessage.textContent = ""; // Effacer les messages d'erreur précédents
              profileErrorMessage.style.display = "none";
              loadProfileDataAndCsrf(); // Charger les données et le jeton CSRF
            });

            // Fermer la modale via le bouton "X"
            closeProfileModalButton.addEventListener("click", () => {
              profileUpdateModal.style.display = "none";
            });

            // Fermer la modale via le bouton "Annuler"
            cancelProfileUpdateButton.addEventListener("click", () => {
              profileUpdateModal.style.display = "none";
            });

            // Fermer la modale si l'utilisateur clique en dehors
            window.addEventListener("click", (event) => {
              if (event.target === profileUpdateModal) {
                profileUpdateModal.style.display = "none";
              }
            });

            // Gérer la soumission du formulaire de mise à jour du profil
            profileUpdateForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const formData = new FormData(profileUpdateForm);

              try {
                const response = await fetch("/api/profile", {
                  method: "PUT",
                  body: formData,
                });
                const result = await response.json();
                console.log("Résultat de la mise à jour du profil:", result); // Ajout d'un log

                if (result.success) {
                  showAlertModal("Profil mis à jour avec succès !", () => {
                    profileUpdateModal.style.display = "none";
                    window.location.href = "/"; // Rediriger vers la session de chat
                  });
                  // Mettre à jour l'avatar et le nom d'utilisateur dans la sidebar si nécessaire
                  if (result.profile.username) {
                    myUserIdSpan.textContent =
                      " - " + result.profile.username + " (Moi)";
                  }
                  if (result.profile.profilePicture) {
                    myAvatarDiv.style.backgroundImage = `url('${result.profile.profilePicture}')`;
                  }
                } else {
                  if (result.errors && Array.isArray(result.errors)) {
                    let errorHtml = "<ul>";
                    result.errors.forEach((err) => {
                      errorHtml += `<li>${err.msg}</li>`;
                    });
                    errorHtml += "</ul>";
                    profileErrorMessage.innerHTML = errorHtml;
                  } else {
                    profileErrorMessage.textContent =
                      result.message ||
                      "Erreur lors de la mise à jour du profil.";
                  }
                  profileErrorMessage.style.display = "block";
                }
              } catch (error) {
                console.error("Erreur:", error);
                profileErrorMessage.textContent =
                  "Erreur réseau lors de la mise à jour du profil.";
                profileErrorMessage.style.display = "block";
              }
            });
          })
          .catch((error) => {
            console.error(
              "Erreur lors du chargement de la modale de profil:",
              error
            );
            profileErrorMessage.textContent =
              "Erreur lors du chargement de la modale de profil.";
            profileErrorMessage.style.display = "block";
          });

        // ----------------------------------------------------
        // LOGIQUE ÉVÉNEMENTIELLE
        // ----------------------------------------------------

        // 1. Gérer la réception de l'historique
        socket.on("history", function (history) {
          history.forEach((msg) => {
            displayMessage(msg);
          });
          displayMessage({
            user: "Système",
            text: "--- Début de l'historique ---",
          });
        });

        // 2. Gérer la réception des nouveaux messages
        socket.on("chat message", function (msg) {
          displayMessage(msg);
          // Incrémenter le compteur si le message n'est pas de l'utilisateur actuel et que la fenêtre n'est pas active
          if (msg.user !== currentUserId && !document.hasFocus()) {
            unreadMessagesCount++;
            updateUnreadMessagesBadge();
          }
        });

        // 3. Gérer la réception de la liste des utilisateurs
        socket.on("user list", function (users) {
          updateUsersList(users);
        });

        // 4. Gérer l'envoi du formulaire
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          if (input.value.trim()) {
            socket.emit("chat message", { text: input.value });
            input.value = "";
            // Réinitialiser le compteur de messages non lus lors de l'envoi d'un message
            unreadMessagesCount = 0;
            updateUnreadMessagesBadge();
          }
        });

        // 5. Gérer le bouton Quitter (Utilisation du modal customisé)
        quitButton.addEventListener("click", function () {
          // Afficher le modal au clic sur le bouton Quitter
          confirmationModal.style.display = "flex";
        });

        // 6. Gérer le bouton de bascule de la sidebar
        sidebarToggleButton.addEventListener("click", function () {
          userSidebar.classList.toggle("active");
        });

        // Fermer la sidebar si on clique en dehors (uniquement en mode overlay)
        document.addEventListener("click", function (event) {
          // Vérifie si la sidebar est active et si le clic n'est pas sur la sidebar ou le bouton toggle
          if (
            userSidebar.classList.contains("active") &&
            !userSidebar.contains(event.target) &&
            !sidebarToggleButton.contains(event.target)
          ) {
            // Vérifie si la media query est active (i.e., si on est en mode mobile/tablette)
            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            if (isMobile) {
              userSidebar.classList.remove("active");
            }
          }
        });

        cancelQuitButton.addEventListener("click", function () {
          // Cacher le modal si l'utilisateur annule
          confirmationModal.style.display = "none";
        });

        confirmQuitButton.addEventListener("click", function () {
          // Logique de déconnexion si l'utilisateur confirme
          confirmationModal.style.display = "none";

          // Rediriger vers la route de déconnexion du serveur
          window.location.href = "/auth/logout";
        });

        // Réinitialiser le compteur de messages non lus lorsque la fenêtre redevient active
        window.addEventListener("focus", () => {
          unreadMessagesCount = 0;
          updateUnreadMessagesBadge();
        });

        // Gérer le cas où le socket est finalement connecté pour mettre à jour l'ID local
        socket.on("connect", () => {
          // L'ID utilisateur est maintenant géré par l'événement 'current user'
          // updateUsersList sera appelée après la réception de 'current user'
        });

        // Gérer les erreurs de connexion Socket.IO (par exemple, non autorisé)
        socket.on("connect_error", (err) => {
          console.error("Erreur de connexion Socket.IO:", err.message);
          if (err.message === "Non autorisé") {
            window.location.href = "/login.html"; // Rediriger vers la page de connexion
          }
        });

        // Gérer l'événement de déconnexion forcée
        socket.on("force_disconnect", (message) => {
          showAlertModal(message, () => {
            window.location.href = "/auth/logout"; // Rediriger vers la page de déconnexion
          });
        });

        // Gérer l'événement de mise à jour du profil
        socket.on("profile_updated", (data) => {
          if (data.userId === currentUserId) {
            // Mettre à jour l'avatar et le nom d'utilisateur dans la sidebar
            if (data.profile.username) {
              myUserIdSpan.textContent =
                " - " + data.profile.username + " (Moi)";
            }
            if (data.profile.profilePicture) {
              myAvatarDiv.style.backgroundImage = `url('${data.profile.profilePicture}')`;
            }
          }
        });
      }); // Fin de DOMContentLoaded
    </script>
  </body>
</html>
